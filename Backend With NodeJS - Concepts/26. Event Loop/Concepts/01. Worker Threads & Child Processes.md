# Topic 26-A Worker Threads & Child Processes (Handling CPU-Heavy Tasks)

---

### **Concept**

Node.js executes JavaScript in a **single thread**.
Because of this, heavy CPU operations like:

* Image/Video processing
* File compression
* Large loops
* Mathematical computations
* Machine learning tasks

can **block the Event Loop**, making API responses slow or unresponsive.

To solve this, Node.js provides two important modules:

| Module             | Purpose                                                          |
| ------------------ | ---------------------------------------------------------------- |
| **Worker Threads** | Run JavaScript in separate threads (parallel)                    |
| **Child Process**  | Run **separate programs** or commands (often other Node scripts) |

---

### **Why Use Them?**

| Problem                                 | Solution                               |
| --------------------------------------- | -------------------------------------- |
| CPU-heavy tasks block requests          | Offload work to Worker Threads         |
| Need to run shell commands              | Use Child Processes                    |
| Need multiple parallel tasks            | Use worker pool                        |
| Need to use other languages (Python/Go) | Child process can run external scripts |

---

### **When to Use What?**

| Use Case                      | Recommended    |
| ----------------------------- | -------------- |
| Heavy calculations in JS      | Worker Threads |
| Video processing using FFmpeg | Child Process  |
| Running Python ML model       | Child Process  |
| Multi-threaded batch tasks    | Worker Threads |
| Database backup command       | Child Process  |

---

## Worker Threads

---

### **Basic Example**

**Folder:**

```
worker-demo/
│
├── main.js
└── worker.js
```

---

### **worker.js**

```js
// worker.js
const { parentPort } = require("worker_threads");

// Heavy CPU task (example: sum from 1 to N)
function heavyWork(n) {
  let sum = 0;
  for (let i = 1; i <= n; i++) sum += i;
  return sum;
}

// Receive data from main thread
parentPort.on("message", (n) => {
  const result = heavyWork(n);
  parentPort.postMessage(result); // send back result
});
```

---

### **main.js**

```js
// main.js
const { Worker } = require("worker_threads");

console.log("Start");

const worker = new Worker("./worker.js");

// Send task
worker.postMessage(5000000000); // 5 billion loop

worker.on("message", (result) => {
  console.log("Result:", result);
});

console.log("End (Event Loop still free)");
```

---

### **Run:**

```bash
node main.js
```

Expected Output (non-blocking main thread):

```
Start
End (Event Loop still free)
Result: 12500000002500000000
```

---

### **Worker Thread Notes**

* Communicates using **message passing** (no shared memory unless SharedArrayBuffer).
* Best for pure JS CPU-bound tasks.
* Create a worker pool for multiple parallel tasks.

---

## Child Process

---

### **Concept**

Runs another script or system command *outside* current Node process.

Useful when:

* You need to run **system commands**
* Execute **Python, Java, Go** code
* Use **FFmpeg, ImageMagick, etc.**

---

### **Example: Execute a Shell Command**

```js
const { exec } = require("child_process");

exec("dir", (error, stdout, stderr) => {
  if (error) return console.error("Error:", error.message);
  if (stderr) return console.error("stderr:", stderr);
  console.log("Output:\n", stdout);
});
```

---

### **Example: Spawn Continuous Output**

```js
const { spawn } = require("child_process");

const ls = spawn("ping", ["google.com"]);

ls.stdout.on("data", (data) => console.log("OUT:", data.toString()));
ls.stderr.on("data", (data) => console.log("ERR:", data.toString()));

ls.on("close", (code) => console.log("Process exited:", code));
```

---

### **Example: Run Python from Node**

```js
const { spawn } = require("child_process");

const py = spawn("python", ["script.py", "10"]);

py.stdout.on("data", data => console.log("Python Output:", data.toString()));
```

---

## Worker Threads vs Child Process

| Feature  | Worker Threads         | Child Processes                  |
| -------- | ---------------------- | -------------------------------- |
| Language | JavaScript only        | Any program (Python, Go, FFmpeg) |
| Memory   | Shared memory possible | Separate memory                  |
| Speed    | Faster for JS CPU work | Slower communication             |
| Use case | Compute-heavy logic    | System commands, external tools  |

---

## Mini Project: Worker Thread API Example

---

### **Create API that computes heavy task without blocking**

**Folder:**

```
api-worker/
│
├── server.js
└── worker.js
```

---

### **worker.js**

```js
const { parentPort } = require("worker_threads");

function fibonacci(n) {
  if (n < 2) return n;
  return fibonacci(n - 1) + fibonacci(n - 2);
}

parentPort.on("message", (num) => {
  const result = fibonacci(num);
  parentPort.postMessage(result);
});
```

---

### **server.js**

```js
const express = require("express");
const { Worker } = require("worker_threads");

const app = express();

app.get("/fib/:n", (req, res) => {
  const n = parseInt(req.params.n);

  const worker = new Worker("./worker.js");
  worker.postMessage(n);

  worker.on("message", (result) => {
    res.json({ number: n, fibonacci: result });
  });
});

app.listen(4000, () => console.log("Server running at http://localhost:4000"));
```

---

### Test using browser/Postman:

`GET http://localhost:4000/fib/40`

Server stays responsive because heavy calculation is offloaded.

---

## Dependencies

| Module                 | Built-in? |
| ---------------------- | --------- |
| worker_threads         | Yes       |
| child_process          | Yes       |
| express (if using API) | No        |

---

## Notes

* Worker threads prevent **Event Loop blocking**.
* Child processes allow running **system or external scripts**.
* For multi-core CPUs, run workers in **parallel**.
* Ideal for tasks like:

  * Encryption/Hashing
  * Data transformation
  * Report generation
  * ML inference

---

## Quick Summary Table

| Task Type                      | Recommended            |
| ------------------------------ | ---------------------- |
| Pure JS heavy calculation      | Worker Threads         |
| Run Python/ffmpeg/bash command | Child Process          |
| Parallel CPU workloads         | Worker Pool            |
| Large processing queue         | BullMQ + Workers       |
| Scaling servers                | Cluster mode + Workers |

---